name: Generate Intelligence Data

on:
  workflow_dispatch:
  schedule:
    - cron: '3,13,23,33,43,53 * * * *'

jobs:
  generate:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout Public Repo (Terminal)
        uses: actions/checkout@v4
        with:
          path: public_repo

      - name: Checkout Private Repo (Core)
        uses: actions/checkout@v4
        with:
          repository: jenadoe/project1-core # 실제 계정명/저장소명으로 확인
          token: ${{ secrets.PAT_FOR_PRIVATE_CODE }}
          path: private_core

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: Run Engine
        run: |
          cd private_core
          pip install -r requirements.txt
          python main.py

      - name: Update Private History (DB Sync)
        run: |
          cd private_core
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/market_history.json
          git commit -m "Sync history: $(date +'%Y-%m-%d %H:%M:%S')" || echo "No history changes"
          git push

      - name: Deploy to Public Docs
        run: |
          # 결과물 복사 (Core -> Terminal)
          cp private_core/data/market_signals.json public_repo/docs/data/
          
          cd public_repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/data/market_signals.json
          git commit -m "Update signals: $(date +'%Y-%m-%d %H:%M:%S')" || echo "No signal changes"
          git push
